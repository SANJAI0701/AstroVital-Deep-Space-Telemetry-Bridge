/**
 * AstroVital Firmware (C++)
 * Target: ESP32 / ESP8266 / Arduino with WiFi Shield
 * * DESCRIPTION:
 * This code acts as the "Space Suit" computer. In a real scenario, it would read
 * from analog sensors (AD8232 for ECG, MAX30100 for SpO2).
 * * For this simulation, it generates a synthetic "PQRST" ECG waveform and 
 * transmits it via MQTT to the Python dashboard.
 */

#include <Arduino.h>
#include <WiFi.h>          // Use <ESP8266WiFi.h> if using ESP8266
#include <PubSubClient.h>  // MQTT Library
#include <ArduinoJson.h>   // JSON formatting

// --- CONFIGURATION ---
const char* ssid = "YOUR_WIFI_SSID";
const char* password = "YOUR_WIFI_PASSWORD";
const char* mqtt_server = "test.mosquitto.org"; // Public Test Broker
const char* topic_telemetry = "astrovital/suit_1/telemetry";

WiFiClient espClient;
PubSubClient client(espClient);

// --- BIOMEDICAL STATE ---
float phase = 0.0;
int heartRate = 60;
float spO2 = 98.0;

void setup_wifi() {
  delay(10);
  Serial.println();
  Serial.print("Connecting to ");
  Serial.println(ssid);
  WiFi.begin(ssid, password);
  while (WiFi.status() != WL_CONNECTED) {
    delay(500);
    Serial.print(".");
  }
  Serial.println("WiFi connected");
}

void reconnect() {
  while (!client.connected()) {
    Serial.print("Attempting MQTT connection...");
    String clientId = "AstroSuit-";
    clientId += String(random(0xffff), HEX);
    if (client.connect(clientId.c_str())) {
      Serial.println("connected");
    } else {
      Serial.print("failed, rc=");
      Serial.print(client.state());
      delay(5000);
    }
  }
}

// --- SYNTHETIC ECG GENERATOR ---
// Generates a math-based approximation of a heartbeat signal
float generateECG() {
  float signal = 0;
  
  // P Wave
  signal += 0.15 * exp(-pow(phase - 0.5, 2) / 0.02);
  // Q Wave
  signal -= 0.15 * exp(-pow(phase - 1.1, 2) / 0.005);
  // R Wave (The big spike)
  signal += 1.00 * exp(-pow(phase - 1.2, 2) / 0.005);
  // S Wave
  signal -= 0.20 * exp(-pow(phase - 1.3, 2) / 0.005);
  // T Wave
  signal += 0.30 * exp(-pow(phase - 2.0, 2) / 0.1);
  
  // Add Baseline Noise (Simulates muscle movement/EMG artifacts)
  signal += (random(-5, 5) / 100.0);

  // Advance phase
  phase += 0.1; 
  if (phase > 3.0) phase = 0.0; // Reset after one beat
  
  return signal;
}

void setup() {
  Serial.begin(115200);
  setup_wifi();
  client.setServer(mqtt_server, 1883);
}

void loop() {
  if (!client.connected()) {
    reconnect();
  }
  client.loop();

  // --- DATA PACKETIZATION ---
  // We create a JSON object to send to the dashboard
  StaticJsonDocument<200> doc;
  
  // 1. Generate Vital Signs
  float ecgValue = generateECG();
  
  // Randomly drift SpO2 to simulate physiology
  if (random(0, 100) > 95) {
     spO2 += (random(-1, 2) * 0.1);
     if(spO2 > 100) spO2 = 100;
     if(spO2 < 85) spO2 = 85; 
  }

  // 2. Build JSON
  doc["suit_id"] = "EVA-01";
  doc["ecg"] = ecgValue;
  doc["spo2"] = spO2;
  doc["bpm"] = heartRate;
  doc["status"] = (spO2 < 90) ? "CRITICAL" : "NORMAL";

  char buffer[512];
  serializeJson(doc, buffer);

  // 3. Publish to MQTT
  client.publish(topic_telemetry, buffer);

  // 4. Sampling Rate
  // 50ms delay = 20Hz transmission rate (approx)
  delay(50); 
}
